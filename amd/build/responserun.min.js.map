{"version":3,"file":"responserun.min.js","sources":["../src/responserun.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Display a button in testing to reveal the prompt that was sent\n *\n * @module     qtype_aitext/responserun\n * @copyright  2024 Marcus Green\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {get_strings} from 'core/str';\nimport Ajax from 'core/ajax';\nimport Notify from 'core/notification';\nimport Log from 'core/log';\nimport {exception as displayException} from 'core/notification';\n\n\nexport const init = (contextid) => {\n\n    const Selectors = {\n        fields: {\n            sampleanswer: '#id_sampleanswer',\n            sampleanswerbtn: '#id_sampleanswerbtn',\n            sampleanswereval: '#id_sampleanswereval',\n        },\n    };\n    let elementcount = document.querySelectorAll(\"[id^='id_sampleanswerbtn']\");\n    let SelectorsWithCount = {};\n\n    for (let i = 0; i < elementcount.length; i++) {\n        SelectorsWithCount.fields = {};\n        for (let key in Selectors.fields) {\n            SelectorsWithCount.fields[key] = Selectors.fields[key] + \"_\" + i;\n            SelectorsWithCount.fields.aiprompt = '#id_aiprompt';\n            SelectorsWithCount.fields.markscheme = '#id_markscheme';\n            SelectorsWithCount.fields.defaultmark = '#id_defaultmark';\n            SelectorsWithCount.fields.spinner = '#id_spinner';\n        }\n        clickSetup(contextid, SelectorsWithCount);\n    }\n\n};\n\n/**\n * Configure event handlers\n *\n * @param {number} contextid\n * @param {object} Selectors\n */\nfunction clickSetup(contextid, Selectors) {\n    // Set up strings\n    var strings = {};\n    get_strings([\n        {\"key\": \"prompttester\", \"component\": 'qtype_aitext'},\n        {\"key\": \"sampleanswerempty\", \"component\": 'qtype_aitext'},\n\n    ]).done(function (s) {\n        var i = 0;\n        strings.prompttester = s[i++];\n        strings.sampleanswerempty = s[i++];\n    });\n    document.querySelector(Selectors.fields.sampleanswerbtn).addEventListener('click', e => {\n        const form = e.target.closest('form');\n        let index = e.target.id.lastIndexOf(\"_\");\n        let id = e.target.id.slice(index + 1);\n\n        const sampleanswer = document.getElementById('id_sampleanswers' + '_'+ id);\n        const sampleanswereval = document.getElementById('id_sampleanswereval' + \"_\" + id);\n\n        const aiprompt = document.getElementById('id_aiprompt');\n        const marksscheme = document.getElementById('id_markscheme');\n        const defaultmark = document.getElementById('id_defaultmark');\n        const spinner = form.querySelector(Selectors.fields.spinner);\n\n        if (sampleanswer.value === \"\" || aiprompt.value === \"\") {\n            Notify.alert(strings.prompttester, strings.sampleanswerempty);\n            return;\n        }\n     // Put  spinner in place.\n     spinner.innerHTML = '<span class=\"loading-icon icon-no-margin\">';\n     spinner.innerHTML += ' <i class=\"fa fa-spinner fa-spin fa-3x fa-fw\"\" title=\"Loading\" role=\"img\" aria-label=\"Loading\"></i>';\n     spinner.innerHTML += '</span>';\n\n     spinner.classList.remove('hide');\n     Ajax.call([{\n        methodname: 'qtype_aitext_fetch_ai_grade',\n        args: {\n            response: sampleanswer.value,\n            defaultmark: defaultmark.value,\n            prompt: aiprompt.value,\n            marksscheme: marksscheme.value,\n            contextid: contextid\n        },\n        async: false\n    }])[0].then(function(airesponse) {\n        Log.debug(airesponse);\n        if (airesponse.feedback) {\n            sampleanswereval.textContent = airesponse.feedback + ' (GRADE: ' + airesponse.marks + '/' + defaultmark.value + ')';\n            spinner.classList.add('hide');\n        }\n        return true;\n    }).fail(error => {\n        displayException(error);\n        sampleanswereval.innerHTML = '';\n    });\n\n}); // End of click.\n\n}\n"],"names":["clickSetup","contextid","Selectors","strings","done","s","i","prompttester","sampleanswerempty","document","querySelector","fields","sampleanswerbtn","addEventListener","e","form","target","closest","index","id","lastIndexOf","slice","sampleanswer","getElementById","sampleanswereval","aiprompt","marksscheme","defaultmark","spinner","value","innerHTML","classList","remove","call","methodname","args","response","prompt","async","then","airesponse","debug","feedback","textContent","marks","add","fail","error","alert","elementcount","querySelectorAll","SelectorsWithCount","length","key","markscheme"],"mappings":";;;;;;;20BA8DSA,WAAWC,UAAWC,eAEvBC,QAAU,wBACF,CACR,KAAQ,yBAA6B,gBACrC,KAAQ,8BAAkC,kBAE3CC,MAAK,SAAUC,OACVC,EAAI,EACRH,QAAQI,aAAeF,EAAEC,KACzBH,QAAQK,kBAAoBH,EAAEC,QAElCG,SAASC,cAAcR,UAAUS,OAAOC,iBAAiBC,iBAAiB,SAASC,UACzEC,KAAOD,EAAEE,OAAOC,QAAQ,YAC1BC,MAAQJ,EAAEE,OAAOG,GAAGC,YAAY,KAChCD,GAAKL,EAAEE,OAAOG,GAAGE,MAAMH,MAAQ,SAE7BI,aAAeb,SAASc,eAAe,oBAA0BJ,IACjEK,iBAAmBf,SAASc,eAAe,uBAA8BJ,IAEzEM,SAAWhB,SAASc,eAAe,eACnCG,YAAcjB,SAASc,eAAe,iBACtCI,YAAclB,SAASc,eAAe,kBACtCK,QAAUb,KAAKL,cAAcR,UAAUS,OAAOiB,SAEzB,KAAvBN,aAAaO,OAAmC,KAAnBJ,SAASI,OAK7CD,QAAQE,UAAY,6CACpBF,QAAQE,WAAa,sGACrBF,QAAQE,WAAa,UAErBF,QAAQG,UAAUC,OAAO,sBACpBC,KAAK,CAAC,CACRC,WAAY,8BACZC,KAAM,CACFC,SAAUd,aAAaO,MACvBF,YAAaA,YAAYE,MACzBQ,OAAQZ,SAASI,MACjBH,YAAaA,YAAYG,MACzB5B,UAAWA,WAEfqC,OAAO,KACP,GAAGC,MAAK,SAASC,gCACbC,MAAMD,YACNA,WAAWE,WACXlB,iBAAiBmB,YAAcH,WAAWE,SAAW,YAAcF,WAAWI,MAAQ,IAAMjB,YAAYE,MAAQ,IAChHD,QAAQG,UAAUc,IAAI,UAEnB,KACRC,MAAKC,oCACaA,OACjBvB,iBAAiBM,UAAY,6BA5BlBkB,MAAM7C,QAAQI,aAAcJ,QAAQK,oCA1DlCP,kBAEXC,iBACM,CACJoB,aAAc,mBACdV,gBAAiB,sBACjBY,iBAAkB,4BAGtByB,aAAexC,SAASyC,iBAAiB,8BACzCC,mBAAqB,OAEpB,IAAI7C,EAAI,EAAGA,EAAI2C,aAAaG,OAAQ9C,IAAK,CAC1C6C,mBAAmBxC,OAAS,OACvB,IAAI0C,OAAOnD,iBACZiD,mBAAmBxC,OAAO0C,KAAOnD,iBAAiBmD,KAAO,IAAM/C,EAC/D6C,mBAAmBxC,OAAOc,SAAW,eACrC0B,mBAAmBxC,OAAO2C,WAAa,iBACvCH,mBAAmBxC,OAAOgB,YAAc,kBACxCwB,mBAAmBxC,OAAOiB,QAAU,cAExC5B,WAAWC,UAAWkD"}